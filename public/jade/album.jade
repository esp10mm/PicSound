doctype html
html
  head
    title Album
    meta(charset='utf-8')
    link(href=href='http://fonts.googleapis.com/css?family=Varela+Round' rel='stylesheet' type='text/css')
    link(href="css/semantic.css" rel="stylesheet" type="text/css")
    style.
      body{
        background-color: #dedede;
        font-family: 'Varela Round', sans-serif;
      }

      .ui.main.menu{
        top: 0px;
        margin-top: 0px;
        width: 100%;
        left: 0px;
        position: fixed;
      }

      .right.menu{
        display: inline;
      }

      .ui.main.segment{
        background-color: #dedede;
        width: 100%;
        height: 100%;
        position: fixed;
        left: 0px;
        z-index: -1;
      }

      .ui.manage.segment{
        width: 40%;
        margin-top: 15px;
        max-height: 90%;
      }

      .ui.slide.segment{
        width: 59%;
        margin-top: 15px;
        height: 95%;
        text-align:center;
      }

      .ui.slide.disp.segment{
        width: 69%;
        left: 15%;
        height: 90%;
      }

      .ui.control.segment{
        height: 8%;
        margin-top: 0px;
        padding-top:3px;
        text-align:center;
      }

      .control.icon{
        display:inline-block;
        position: relative;
      }

      .ui.image{
        display: block;
        top: auto%;
        margin: auto;
      }

      .ui.mini.button{
        display: inline;
      }

      .ui.segment.tag{
        padding-left:3px;
      }

      .ui.tag.label{
        margin-top: 3px;
      }

      #tags{
        margin-left:3px;
        padding-left:0px;
      }

      .ui.segment.song{
        padding-left:3px;
      }

      .ui.song_disp.segment{
        margin-top: 0px;
        padding-top: 0px;
      }

      .ui.song.message{
        width: 100%;
      }

      .ui.song.image{
        float: left;
        width: 80px;
        height: 80px;
        display: inline;
        vertical-align: middle;
        margin-right: 20px;
      }

      .song.content{
        display: inline-block;
        height: 80px;
        vertical-align: middle;
      }

      .song.control{
        float: right;
        vertical-align: middle;
        text-align: center;
        z-index: 200;
      }

      .song.icon{
        font-size: 3em;
        vertical-align: middle;
      }

      #songs{
        margin-left:3px;
        padding-left:0px;
      }

    body
      div(class="ui inverted main menu")
        a(class="item" href="/")
          i(class="home icon")
          |Home
        a(class="item")
          i(class="photo icon")
          |Albums
        a(class="item")
          i(class="globe icon")
          |Browse
        div(class="right menu")
          div(class="item")
            div(class="ui icon input")
              input(type="text" placeholder="Search...")
              i(class="search link icon")

      div(class="ui main segment")
        div(class="ui secondary left floated manage segment",id="album_manage")
          div(class="ui tabular tag_song menu")
            a(class="active item" onclick="tagDisp()")
              |Tags
            a(class="item" onclick="songDisp()")
              |Recommend Song
          div(class="ui basic segment tag")
            div(class="ui basic disp segment" id="tags")
            div(class="ui small icon button" data-html='New Tag : <br><div class="ui mini input"><input type="text" id="newTag"></div>&nbsp;<div class="ui mini button" onclick="newTag()">OK</div>')
              i(class="add icon")
          div(class="ui inactive basic raised segment song")
            div(class="ui basic song segment" id="songs")
            div(class="ui pagination song page menu" id="song_page")

        div(class="ui secondary right floated stacked slide segment")
          div(class= "ui slide basic disp segment" id="slide")
          div(class= "ui control basic segment")
            i(class= "step backward big control icon")
            i(class= "big control icon play")
            i(class= "step forward big control icon")

      script(src="//code.jquery.com/jquery-1.11.0.min.js" type="text/javascript")
      script(src="javascript/semantic.js" type="text/javascript")
      script.

        var slide_cur = 0;
        var slide_len ;
        var play_flag = false;
        var timer;
        var songs = [];
        var nowPlaying = null;
        var songNowPage = 1;

        $( document ).ready(function() {

          loadPhotos();
          loadTags();

          var loadCount = 0;
          $('.image').on('load',function(){
            var w = $(this).width();
            var h = $(this).height();
            $(this).attr('ow',w);
            $(this).attr('oh',h);
            var sw = $('.slide.disp').width();
            var sh = $('.slide.disp').height();

            if(w > sw){
              $(this).width(sw);
            }
            if(h > sh){
              $(this).height(sh);
            }
            if(!$(this).hasClass('slide0'))
              $(this).hide();
            var top = (sh - $(this).height())/2;
            $(this).css('top',top+'px');
            loadCount += 1;
            if(loadCount == slide_len)
              $('.play.control').click();
          });

          $( '.inactive' ).hide();

          $('.manage .tag_song .item').on('click', function() {
            $('.manage .tag_song .item').removeClass('active');
            $(this).addClass('active');
          });

          $('.manage .tag .button').popup({
            on: 'click',
          });

          $(window).resize(function() {
            resetImgSize();
          });

          $('.forward.control').on('click',function(){
            var sel,sel2;
            if(slide_cur < (slide_len-1)){
              sel = ".slide" + slide_cur;
              sel2 = ".slide" + (slide_cur+1);
            }
            else{
              sel = ".slide" + (slide_len-1);
              sel2 = ".slide0";
              slide_cur = -1;
            }
            $(sel).hide();
            $(sel2).show();
            slide_cur += 1;
          })

          $('.backward.control').on('click',function(){
            var sel,sel2;
            if(slide_cur == 0){
              sel2 = ".slide0";
              sel = ".slide" + (slide_len-1);
              slide_cur = slide_len;
            }
            else{
              sel = ".slide" + (slide_cur-1);
              sel2 = ".slide" + slide_cur;
            }

            $(sel2).hide();
            $(sel).show();
            slide_cur -= 1;
          })

          $('.play.control').on('click',function(){
              if(!play_flag){
                $(this).removeClass('play');
                $(this).addClass('pause');
                play_flag = true;
                playSlide();
              }
              else{
                clearTimeout(timer);
                $(this).removeClass('pause');
                $(this).addClass('play');
                play_flag = false;
              }
          })

        })

        function resetImgSize(){
          console.log('resize');
          $('.image').each(function(){
              var w = $(this).attr('ow');
              var h = $(this).attr('oh');
              $(this).width(w);
              $(this).height(h);
              var sw = $('.slide.disp').width();
              var sh = $('.slide.disp').height();

              var ratio = w/h;

              if(w > sw){
                $(this).width(sw*0.9);
              }
              if(h > sh){

                $(this).height(sh*0.9);
              }

            });
        }

        function loadPhotos(){
          var photos = !{JSON.stringify(photos)};
          slide_len = photos.length;
          var slideHTML = ""
          for(var k in photos){
            slideHTML = slideHTML + '<img class="ui image slide'+k+'" src="/image?id=' + photos[k] + '">'
          }
          document.getElementById('slide').innerHTML = slideHTML;
        }

        function songDisp(){
          $( '.ui .segment .tag' )
            .hide()
            .end()
            .find('.ui.segment.song')
            .slideDown();
        }

        function tagDisp(){
          $( '.ui.segment.song' )
            .hide()
            .end()
            .find('.ui.segment.tag')
            .slideDown();
        }

        function loadTags(){
          $.get("/getTags",{id:!{JSON.stringify(id)}},function(res){
              if(res.length == 0){
                document.getElementById('tags').innerHTML = "<div class='ui icon message'> <i class='frown icon'></i> <div class='content'> <div class='header'> This album has no tag yet ... </div> <p>Add some with the add button below !</p> </div> </div>";
                document.getElementById('songs').innerHTML = "<div class='ui icon message'> <i class='frown icon'></i> <div class='content'> <div class='header'> We need some tag to recommend ... </div> <p>Add some in left tag page !</p> </div> </div>";
              }
              else{
                var tagsHTML="";
                for(var k in res){
                  tagsHTML = tagsHTML + "<div class='ui label'>"+res[k]+"<i class='delete icon'></i></div>";
                }
                document.getElementById('tags').innerHTML = tagsHTML;
                /*document.getElementById('songs').innerHTML = '<iframe frameborder="0" width="400" height="405" allowtransparency="true" class="spotify">'
                $('.spotify').attr('src','http://embed.spotify.com/?uri=spotify:trackset:PREFEREDTITLE:5Z7ygHQo02SUrFmcgpwsKW,1x6ACsKV4UdWS2FMuPFUiT,4bi73jCM02fMpkI11Lqmfe')*/
                loadSong();
              }
          })
        }

        function loadSong(tags){
          $.get("/getRecSong",{id:!{JSON.stringify(id)}},function(res){
              //console.log(res);
              var songsMaxHeight = $('.stacked.slide.segment').height()-$('.tabular.menu').height();
              var page = 1;

              if(res.length > 0){
                var songHTML = "<div class='ui basic segment song_disp page1'>";
                for(var k in res){
                  console.log(songsMaxHeight);
                  songsMaxHeight -= 110;
                  songHTML = songHTML + "<div class='ui song message'><img class='ui song image' src='"+res[k].image+"'><div class='song content'><div class='header'>"+res[k].name+"</div><p>"+res[k].artist+"</p></div><div class='song control'><i class='song play icon' song="+k+"></i></div></div>";
                  var audioElement = document.createElement('audio');
                  audioElement.setAttribute('src',res[k].preview);
                  songs.push(audioElement);
                  if(songsMaxHeight <= 330 && k<res.length-1){
                    page += 1;
                    songsMaxHeight = $('.stacked.slide.segment').height()-$('.tabular.menu').height();
                    songHTML += "</div><div class='ui inactive basic segment song_disp page"+page+"'>";
                  }
                }
                songHTML += "</div>"
                document.getElementById('songs').innerHTML = songHTML;
                $('.inactive').hide();

                var pageHTML = "<a class='icon item' dir='-1'><i class='left arrow icon'></i></a><a class='active pnum item page1'>1</a>";
                for(var k = 2;k <= page;k++){
                  pageHTML = pageHTML + "<a class='pnum item page"+k+"'>"+k+"</a>";
                }
                pageHTML += "<a class='icon item' dir='1'><i class='right arrow icon'></i>";
                document.getElementById('song_page').innerHTML = pageHTML;

                $('.page .pnum.item').click(function(){
                  if(songNowPage != $(this).text()){
                    $('.page .pnum.item').removeClass('active');
                    $(this).addClass('active');
                    $('.segment.page'+songNowPage).hide();
                    $('.segment.page'+$(this).text()).slideDown();
                    songNowPage = $(this).text();
                  }
                })

                $('.page .icon.item').click(function(){
                  console.log(page);
                  var nextPage = parseInt(songNowPage) + parseInt($(this).attr('dir'));
                  if(!(nextPage>page || nextPage<1)){
                    $('.page .pnum.item').removeClass('active');
                    $('.page .pnum.item.page'+nextPage).addClass('active');
                    $('.segment.page'+songNowPage).hide();
                    $('.segment.page'+nextPage).slideDown();
                    songNowPage = nextPage;
                  }
                })

                $('.song.play').click(function() {
                  if(nowPlaying != null){
                    var t = $('.song.pause').attr('song');
                    songs[t].pause();
                    $('.song.pause').removeClass('pause').addClass('play');
                    if(t == $(this).attr('song')){
                      nowPlaying = null;
                      return;
                    }
                  }
                  var song = songs[$(this).attr('song')];
                  nowPlaying = $(this);
                  song.play();
                  $(this).removeClass('play');
                  $(this).addClass('pause');
                })

                $.each(songs,function(){
                  $(this).on('ended',function(){
                    $('.song.pause').removeClass('pause').addClass('play');
                    nowPlaying = null;
                  })
                })

              }
          })
        }

        function newTag(){
          var tag = $('#newTag').val();
          if(tag != null){
            $.get("/addTag",{id:!{JSON.stringify(id)},tag:tag},function(res){
              if(res.success){
                //readTags();
                loadTags();
              }
            });
          }
          $('.manage .tag .button').popup('hide');
        }

        function playSlide(){
          if(!play_flag)
            return;
          timer = setTimeout(function(){
            var sel,sel2;
            if(slide_cur < (slide_len-1)){
              sel = ".slide" + slide_cur;
              sel2 = ".slide" + (slide_cur+1);
            }
            else{
              sel = ".slide" + (slide_len-1);
              sel2 = ".slide0";
              slide_cur = -1;
            }
            $(sel).hide();
            $(sel2).show();
            slide_cur += 1;

            playSlide();
          },2000)
        }
